name: Check Pull Request

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read
  actions: read

concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  check-chart-version:
    name: Check Chart Version Updated
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Changed File Directories
        id: changed-files
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          CHANGED_DIRS=$(git diff --name-only "$BASE...$HEAD" \
            | awk -F/ 'NF>=2{print $1"/"$2}' | sort -u)
          {
            echo "changed_dirs<<EOF"
            echo "$CHANGED_DIRS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Verify Chart Version Bumped
        if: contains(steps.changed-files.outputs.changed_dirs, 'charts/')
        env:
          CHANGED_DIRS: ${{ steps.changed-files.outputs.changed_dirs }}
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          for dir in $CHANGED_DIRS; do
            [[ $dir == charts/* ]] || continue
            chart_name="${dir##*/}"
            if git diff --unified=0 "$BASE...$HEAD" -- "$dir/Chart.yaml" \
                 | grep -qE '^\+version:[[:space:]]'; then
              echo "Chart.yaml version updated for chart: $chart_name"
            else
              echo "ERROR: Chart.yaml version not updated for changed chart: $chart_name"
              exit 1
            fi
          done

  validate-conventional-commits:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    needs: check-chart-version
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate PR Commits Follow Conventional Commits Format
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"

          # Check that commits follow conventional commits format
          # Format: type(scope?): description
          COMMIT_RANGE="$BASE..$HEAD"
          COMMITS=$(git log "$COMMIT_RANGE" --pretty=%B)

          if ! echo "$COMMITS" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:'; then
            echo "WARNING: Some commits may not follow conventional commits format"
            echo "Conventional commits format: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build"
            echo ""
            echo "Recent commits:"
            git log "$COMMIT_RANGE" --oneline
          fi

name: Check Pull Request

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  check-chart-version:
    name: Check Chart Version Updated
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get Changed File Directories
        id: changed-files
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          CHANGED_DIRS=$(git diff --name-only "$BASE...$HEAD" \
            | awk -F/ 'NF>=2{print $1"/"$2}' | sort -u)
          {
            echo "changed_dirs<<EOF"
            echo "$CHANGED_DIRS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Verify Chart Version Bumped
        if: contains(steps.changed-files.outputs.changed_dirs, 'charts/')
        env:
          CHANGED_DIRS: ${{ steps.changed-files.outputs.changed_dirs }}
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          for dir in $CHANGED_DIRS; do
            [[ $dir == charts/* ]] || continue
            chart_name="${dir##*/}"
            if git diff --unified=0 "$BASE...$HEAD" -- "$dir/Chart.yaml" \
                 | grep -qE '^\+version:[[:space:]]'; then
              echo "Chart.yaml version updated for chart: $chart_name"
            else
              echo "ERROR: Chart.yaml version not updated for changed chart: $chart_name"
              exit 1
            fi
          done

  update-changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: check-chart-version
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CHANGELOG_BOT_APP_ID }}
          private-key: ${{ secrets.CHANGELOG_BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Code (with app token)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}

      - name: Determine Changed Charts
        id: changed-charts
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          CHANGED_CHARTS=$(git diff --name-only "$BASE...$HEAD" \
            | awk -F/ '/^charts\/[^/]+\/Chart\.yaml$/{print $2}' | sort -u)
          {
            echo "changed_charts<<EOF"
            echo "$CHANGED_CHARTS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Update Changelogs
        if: steps.changed-charts.outputs.changed_charts != ''
        env:
          CHANGED_CHARTS: ${{ steps.changed-charts.outputs.changed_charts }}
        run: |
          set -euo pipefail
          for chart in $CHANGED_CHARTS; do
            echo "Updating changelog for chart: $chart"
            CHART_FILE="charts/$chart/Chart.yaml"
            CHANGELOG_FILE="charts/$chart/CHANGELOG.md"
            
            # Get chart version and appVersion
            CHART_VERSION=$(sed -nE 's/^version:[[:space:]]*"?([^"[:space:]]+)"?.*/\1/p' "$CHART_FILE" | head -n1)
            APP_VERSION=$(sed -nE 's/^appVersion:[[:space:]]*"?([^"[:space:]]+)"?.*/\1/p' "$CHART_FILE" | head -n1)
            
            if [ -z "${CHART_VERSION:-}" ]; then
              echo "ERROR: Could not parse version from $CHART_FILE"
              exit 1
            fi
            
            # Check if this version already exists in changelog (escape dots in version for regex)
            ESCAPED_VERSION=$(printf '%s\n' "$CHART_VERSION" | sed 's/[.]/\\./g')
            if grep -qE "^##[[:space:]]*\[?v?${ESCAPED_VERSION}\]?" "$CHANGELOG_FILE"; then
              echo "Changelog already has entry for version $CHART_VERSION"
              continue
            fi
            
            # Determine the package name for the changelog message
            case "$chart" in
              meshcentral)
                PACKAGE_NAME="MeshCentral"
                ;;
              cloudflare-tunnel|cloudflare-tunnel-remote)
                PACKAGE_NAME="cloudflared"
                ;;
              fax-ui)
                PACKAGE_NAME="fax-ui"
                ;;
              *)
                PACKAGE_NAME="$chart"
                ;;
            esac
            
            # Insert new changelog entry after the "# Changelog" header
            echo "Adding changelog entry for version $CHART_VERSION"
            {
              head -1 "$CHANGELOG_FILE"
              echo "## [${CHART_VERSION}]"
              echo "### Changed"
              echo "- Bump ${PACKAGE_NAME} to ${APP_VERSION}"
              echo ""
              tail -n +2 "$CHANGELOG_FILE"
            } > "$CHANGELOG_FILE.tmp"
            mv "$CHANGELOG_FILE.tmp" "$CHANGELOG_FILE"
          done

      - name: Configure Git for Commit
        run: |
          set -euo pipefail
          git config user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config user.email '${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Commit Changelog Updates
        run: |
          set -euo pipefail
          if ! git diff --quiet -- charts/*/CHANGELOG.md; then
            git add charts/*/CHANGELOG.md
            git commit -m "chore: update changelog(s) based on Chart.yaml version"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No CHANGELOG.md changes to commit."
          fi
